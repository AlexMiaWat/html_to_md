Процедура РазобратьHTML_В_MD(ТекстHTML, ТабличныйДокумент)
	
	// Создаём объект для чтения HTML
	ЧтениеHTML = Новый ЧтениеHTML;
	ЧтениеHTML.УстановитьСтроку(ТекстHTML);

	// Создаём объект Построитель DOM
	ПостроительDOM = Новый ПостроительDOM;
	ДокументHTML = ПостроительDOM.Прочитать(ЧтениеHTML);

	// Инициализируем табличный документ
	ТабличныйДокумент = Новый ТекстовыйДокумент();
	
	ИтераторДерева = ДокументHTML.СоздатьОбходДерева(ДокументHTML.ЭлементДокумента);

	Пока ИтераторДерева.СледующийУзел() <> Неопределено Цикл
		
		Узел = ИтераторДерева.ТекущийУзел;
		Если Узел.ИмяУзла = "body" Тогда
			РекурсивныйОбходДерева(Узел, ТабличныйДокумент);
		КонецЕсли;
	
	КонецЦикла;

КонецПроцедуры

Процедура РекурсивныйОбходДерева(Узел, ТабличныйДокумент)
	
	Для Каждого Элемент Из Узел.ДочерниеУзлы Цикл
		
		РекурсивныйОбходЭлементов(Элемент, ТабличныйДокумент);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура РекурсивныйОбходЭлементов(Элемент, ТабличныйДокумент)
    
    // Сохраняем порядок строк
    СтрокаИндекс = ТабличныйДокумент;
    
    Если Элемент.ИмяУзла = "table" Тогда
        ДобавитьТаблицу(Элемент, ТабличныйДокумент);
        
    Иначе
        // Обработка других элементов
        Если Элемент.ИмяУзла = "h1" Тогда
            ТабличныйДокумент.ДобавитьСтроку("## " + Элемент.Текст);
        Иначе
            Если Элемент.ИмяУзла = "h2" Тогда
                ТабличныйДокумент.ДобавитьСтроку("### " + Элемент.Текст);
            Иначе
                Если Элемент.ИмяУзла = "h3" Тогда
                    ТабличныйДокумент.ДобавитьСтроку("#### " + Элемент.Текст);
                Иначе
                    Если Элемент.ИмяУзла = "p" Тогда
                        ТабличныйДокумент.ДобавитьСтроку(Элемент.Текст + "\n");
                    Иначе
                        Если Элемент.ИмяУзла = "ul" Тогда
                            Для Каждого ЭлементСписка Из Элемент.ДочерниеУзлы Цикл
                                ТабличныйДокумент.ДобавитьСтроку("- " + ЭлементСписка.Текст);
                            КонецЦикла;
                        Иначе
                            Если Элемент.ИмяУзла = "ol" Тогда
                                НомерПункта = 1;
                                Для Каждого ЭлементСписка Из Элемент.ДочерниеУзлы Цикл
                                    ТабличныйДокумент.ДобавитьСтроку(НомерПункта + ". " + ЭлементСписка.Текст);
                                    НомерПункта = НомерПункта + 1;
                                КонецЦикла;
                            Иначе
                                // Обработка других элементов по умолчанию
                                ТабличныйДокумент.ДобавитьСтроку(Элемент.Текст + "\n");
                            КонецЕсли;
                        КонецЕсли;
                    КонецЕсли;
                КонецЕсли;
            КонецЕсли;
        КонецЕсли;
    
    КонецЕсли;

КонецПроцедуры

Процедура ДобавитьТаблицу(ТаблицаЭлемент, ТабличныйДокумент)
	
	// Создаём строку заголовка таблицы
	Строки = "";
	Для Каждого Строка Из ТаблицаЭлемент.ДочерниеУзлы Цикл
		Если Строка.ИмяУзла = "tr" Тогда
			СтрокаТаблицы = "";
			Для Каждого Ячейка Из Строка.ДочерниеУзлы Цикл
				ЯчейкаТекст = Ячейка.Текст;
				// Экранируем символы вертикальной черты
				ЯчейкаТекст = СтрЗаменить(ЯчейкаТекст, "|", "\|");
				СтрокаТаблицы = СтрокаTаблицы + " | " + ЯчейкаТекст;
			КонецЦикла;
			Строки = Строки + СтрокаTаблицы + " |\n";
		КонецЕсли;
	КонецЦикла;

	// Добавляем разделитель
	Заголовок = "";
	// Получаем первую строку таблицы (заголовок)
	ПерваяСтрока = ТаблицаЭлемент.ДочерниеУзлы[1];
	Если ПерваяСтрока <> Неопределено Тогда
		Для Каждого Ячейка Из ПерваяСтрока.ДочерниеУзлы Цикл
			Заголовок = Заголовок + " | ---";
			// Используем итератор для корректной обработки
		КонецЦикла;
	КонецЕсли;
	Строки = СтрокаTаблицы + " |\n" + Заголовок + " |\n" + Строки;

	// Добавляем таблицу в документ
	ТабличныйДокумент.ДобавитьСтроку(Строки);

КонецПроцедуры
